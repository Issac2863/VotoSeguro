<div class="login-page">
    <div class="login-container">
        <div class="login-card">
            <!-- Icono de usuario -->
            <div class="user-icon-wrapper">
                <div class="user-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </div>
            </div>

            <!-- Título -->
            <h1 class="login-title">Autenticación de Votante</h1>
            <p class="login-subtitle">Ingrese sus credenciales para acceder al sistema</p>

            <!-- Indicador de pasos -->
            <div class="step-indicator">
                <span class="step-current">Paso {{ currentStep }} de 3</span>
                <span class="step-label">{{ stepLabels[currentStep - 1] }}</span>
            </div>

            <!-- Mensajes de error y éxito -->
            <div class="alert alert-error" *ngIf="errorMessage">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {{ errorMessage }}
            </div>

            <div class="alert alert-success" *ngIf="successMessage">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {{ successMessage }}
            </div>

            <!-- Loading spinner -->
            <div class="loading-overlay" *ngIf="isLoading">
                <div class="spinner"></div>
                <span>Procesando...</span>
            </div>

            <!-- PASO 1: Credenciales -->
            <div class="step-content" *ngIf="currentStep === 1 && !isLoading">
                <div class="info-box">
                    <div class="info-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2" />
                        </svg>
                    </div>
                    <div class="info-content">
                        <h3>Ingrese sus credenciales</h3>
                        <p>Use su cédula ecuatoriana junto con su código dactilar para autenticarse.</p>
                    </div>
                </div>

                <form [formGroup]="credentialsForm">
                    <!-- Tipo de documento -->
                    <div class="form-group">
                        <label class="form-label">Tipo de Documento</label>
                        <select class="form-input" formControlName="documentType">
                            <option value="cedula">Cédula Ecuatoriana</option>
                        </select>
                    </div>

                    <!-- Número de documento -->
                    <div class="form-group">
                        <label class="form-label">Número de Cédula</label>
                        <input type="text" class="form-input" formControlName="documentNumber"
                            placeholder="Ej: 1500958069" maxlength="10"
                            [class.input-error]="credentialsForm.get('documentNumber')?.invalid && credentialsForm.get('documentNumber')?.touched">
                        <small class="form-error"
                            *ngIf="credentialsForm.get('documentNumber')?.touched && documentNumberError">
                            {{ documentNumberError }}
                        </small>
                    </div>

                    <!-- Código dactilar -->
                    <div class="form-group">
                        <label class="form-label">Código Dactilar</label>
                        <input type="text" class="form-input" formControlName="fingerprintCode"
                            placeholder="Ej: V4443V4444" maxlength="10" style="text-transform: uppercase;"
                            [class.input-error]="credentialsForm.get('fingerprintCode')?.invalid && credentialsForm.get('fingerprintCode')?.touched">
                        <small class="form-hint">El código dactilar se encuentra en su cédula de identidad</small>
                        <small class="form-error"
                            *ngIf="credentialsForm.get('fingerprintCode')?.touched && fingerprintCodeError">
                            {{ fingerprintCodeError }}
                        </small>
                    </div>
                </form>

                <button class="btn btn-primary btn-block" (click)="nextStep()" [disabled]="credentialsForm.invalid">
                    Continuar
                </button>
            </div>

            <!-- PASO 2: Verificación por OTP (Email) -->
            <div class="step-content" *ngIf="currentStep === 2 && !isLoading">
                <div class="info-box" *ngIf="!codeSent">
                    <div class="info-icon email-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div class="info-content">
                        <h3>Verificación por correo</h3>
                        <p>Se enviará un código de verificación a<br><strong>{{ maskedEmail }}</strong></p>
                        <p class="info-warning">Si este no es su correo, comuníquese con soporte técnico.</p>
                    </div>
                </div>

                <div class="info-box success" *ngIf="codeSent">
                    <div class="info-icon email-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="info-content">
                        <h3>Código enviado</h3>
                        <p>Hemos enviado un código de verificación a<br><strong>{{ maskedEmail }}</strong></p>
                    </div>
                </div>

                <div *ngIf="!codeSent">
                    <button class="btn btn-primary btn-block" (click)="sendCode()">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        Enviar código
                    </button>
                </div>

                <div *ngIf="codeSent">
                    <div class="form-group">
                        <label class="form-label">Código de Verificación (6 dígitos)</label>
                        <input type="text" class="form-input code-input" [(ngModel)]="verificationCode"
                            placeholder="123456" maxlength="6" (paste)="$event.preventDefault()" autocomplete="off"
                            inputmode="numeric">
                        <small class="form-hint">⚠️ Por seguridad, el código debe ser escrito manualmente</small>
                    </div>

                    <button class="btn btn-primary btn-block" (click)="nextStep()"
                        [disabled]="verificationCode.length !== 6">
                        Verificar código
                    </button>
                </div>
            </div>

            <!-- PASO 3: Verificación Facial -->
            <div class="step-content" *ngIf="currentStep === 3 && !isLoading">
                <div class="info-box">
                    <div class="info-icon camera-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <div class="info-content">
                        <h3>Verificación Facial</h3>
                        <p>Tome una foto de su rostro para completar la verificación de identidad.</p>
                    </div>
                </div>

                <!-- Selector de Cámara -->
                <div class="form-group" *ngIf="availableCameras.length > 1" style="margin-bottom: 1rem;">
                    <label class="form-label">Seleccionar Cámara</label>
                    <select class="form-input" (change)="onCameraChange($event)" [value]="selectedCameraId">
                        <option *ngFor="let camera of availableCameras; let i = index" [value]="camera.deviceId">
                            {{ camera.label || 'Cámara ' + (i + 1) }}
                        </option>
                    </select>
                </div>

                <!-- Área de cámara -->
                <div class="camera-section">
                    <!-- Video en vivo (siempre en DOM, oculto cuando no activo) -->
                    <div class="camera-preview" [hidden]="capturedImage">
                        <video #videoElement autoplay playsinline [hidden]="!isCameraActive"></video>
                        <div class="camera-overlay" *ngIf="isCameraActive">
                            <div class="face-guide"></div>
                        </div>
                        <!-- Placeholder cuando no hay cámara -->
                        <div class="camera-placeholder-inner" *ngIf="!isCameraActive">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            <p>La cámara se activará automáticamente</p>
                        </div>
                    </div>

                    <!-- Imagen capturada -->
                    <div class="camera-preview" *ngIf="capturedImage">
                        <img [src]="capturedImage" alt="Foto capturada">
                    </div>

                    <!-- Canvas oculto para captura -->
                    <canvas #canvasElement style="display: none;"></canvas>
                </div>

                <!-- Botones de control de cámara -->
                <div class="camera-controls">
                    <button class="btn btn-secondary" *ngIf="isCameraActive && !capturedImage" (click)="captureImage()">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        </svg>
                        Tomar foto
                    </button>

                    <!-- Opción de subir foto -->
                    <label class="btn btn-outline" *ngIf="!capturedImage">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Subir foto
                        <input type="file" accept="image/*" (change)="onFileSelected($event)" hidden>
                    </label>

                    <button class="btn btn-outline" *ngIf="capturedImage" (click)="retakePhoto()">
                        Tomar/Subir otra foto
                    </button>

                    <button class="btn btn-primary btn-block" *ngIf="capturedImage" (click)="verifyAndLogin()">
                        Verificar e Ingresar
                    </button>
                </div>
            </div>

            <!-- Botón Volver -->
            <button class="btn btn-outline btn-block" (click)="previousStep()"
                *ngIf="(currentStep > 1 || codeSent) && !isLoading">
                Volver
            </button>

            <a routerLink="/" class="btn btn-outline btn-block" *ngIf="currentStep === 1 && !codeSent && !isLoading">
                Volver al Inicio
            </a>

            <!-- Enlace de ayuda -->
            <div class="help-link">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ¿Necesita ayuda? Contacte al soporte técnico
            </div>
        </div>
    </div>
</div>